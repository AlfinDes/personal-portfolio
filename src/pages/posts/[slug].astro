---
import Layout from '../../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';
import cv from '../../../cv.json';

// Get current language from cookie or default to Indonesian
const lang = Astro.cookies.get('language')?.value || 'id';

// Import translations
const translations = await import(`../../i18n/${lang}.json`);
const t = translations.default;

// Get slug from URL
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/posts');
}

// Get all posts and find the one matching our slug and language
const allPosts = await getCollection('posts');

// Try to find post for current language first
let post = allPosts.find(p => {
  const postSlug = p.id.replace(/\.(id|en)\.mdx$/, '');
  return postSlug === slug && p.data.lang === lang;
});

// If not found, try Indonesian
if (!post) {
  post = allPosts.find(p => {
    const postSlug = p.id.replace(/\.(id|en)\.mdx$/, '');
    return postSlug === slug && p.data.lang === 'id';
  });
}

// If still not found, try English
if (!post) {
  post = allPosts.find(p => {
    const postSlug = p.id.replace(/\.(id|en)\.mdx$/, '');
    return postSlug === slug && p.data.lang === 'en';
  });
}

// If still no post, redirect
if (!post) {
  return Astro.redirect('/posts');
}

// Render the MDX content
const { Content } = await post.render();

// Get translated content - use the post's language if current lang not available
const postLang = post.data.lang as 'id' | 'en';
const title = post.data.title[lang as 'id' | 'en'] || post.data.title[postLang];
const excerpt = post.data.excerpt[lang as 'id' | 'en'] || post.data.excerpt[postLang];
const backToPostsText = t.ui.buttons.back_to_posts;
const publishedOnText = t.ui.sections.published_on;

// Format date
const formattedDate = new Date(post.data.date).toLocaleDateString(lang === 'id' ? 'id-ID' : 'en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Layout 
  title={`${title} - ${cv.basics.name}`}
  description={excerpt}
>
  <main class="min-h-screen pt-24 pb-16 px-6">
    <article class="max-w-4xl mx-auto">
      {/* Back Button */}
      <a 
        href="/posts" 
        class="inline-flex items-center gap-2 text-skin-hue hover:text-skin-hue/80 transition-colors mb-8 group"
      >
        <Icon name="ri:arrow-left-line" class="w-5 h-5 group-hover:-translate-x-1 transition-transform" />
        <span class="font-medium">{backToPostsText}</span>
      </a>

      {/* Article Header */}
      <header class="mb-12">
        <h1 class="text-3xl md:text-5xl font-bold text-skin-base mb-6 leading-tight">
          {title}
        </h1>
        
        <div class="flex flex-wrap items-center gap-4 text-sm text-skin-muted mb-6">
          <div class="flex items-center gap-2">
            <Icon name="ri:calendar-line" class="w-4 h-4" />
            <time datetime={post.data.date}>
              {publishedOnText} {formattedDate}
            </time>
          </div>
        </div>

        {/* Tags */}
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map((tag: string) => (
              <span class="px-3 py-1 text-sm font-medium bg-skin-hue/10 text-skin-hue rounded-full">
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      {/* Article Content - MDX */}
      <div class="prose prose-lg max-w-none article-content">
        <Content />
      </div>

      {/* Footer Navigation */}
      <footer class="mt-16 pt-8 border-t border-skin-muted/20">
        <a 
          href="/posts" 
          class="inline-flex items-center gap-2 px-6 py-3 bg-skin-hue text-white rounded-lg hover:bg-skin-hue/90 transition-all hover:shadow-lg hover:shadow-skin-hue/20"
        >
          <Icon name="ri:arrow-left-line" class="w-5 h-5" />
          <span class="font-medium">{backToPostsText}</span>
        </a>
      </footer>
    </article>
  </main>
</Layout>

<style is:global>
  .article-content {
    @apply text-base md:text-lg text-skin-muted;
  }

  .article-content h2 {
    @apply text-2xl md:text-3xl font-bold text-skin-base mt-8 mb-4;
    scroll-margin-top: 6rem;
  }

  .article-content h3 {
    @apply text-xl md:text-2xl font-bold text-skin-base mt-6 mb-3;
  }

  .article-content p {
    @apply mb-6 leading-relaxed text-skin-muted;
  }

  .article-content ul,
  .article-content ol {
    @apply my-6 ml-6 space-y-2;
  }

  .article-content ul {
    @apply list-disc;
  }

  .article-content ol {
    @apply list-decimal;
  }

  .article-content li {
    @apply text-skin-muted leading-relaxed;
  }

  .article-content a {
    @apply text-skin-hue hover:text-skin-hue/80 underline transition-colors;
  }

  .article-content code {
    @apply bg-skin-muted/10 text-skin-hue px-1.5 py-0.5 rounded text-sm;
  }

  .article-content pre {
    @apply bg-skin-muted/10 p-4 rounded-lg overflow-x-auto my-6;
  }

  .article-content pre code {
    @apply bg-transparent p-0;
  }

  .article-content blockquote {
    @apply border-l-4 border-skin-hue pl-4 italic my-6 text-skin-muted;
  }

  .article-content strong {
    @apply font-bold text-skin-base;
  }

  .article-content em {
    @apply italic;
  }

  .article-content hr {
    @apply border-skin-muted/20 my-8;
  }

  .article-content img {
    @apply rounded-lg my-6;
  }

  .article-content table {
    @apply w-full my-6 border-collapse;
  }

  .article-content th,
  .article-content td {
    @apply border border-skin-muted/20 px-4 py-2;
  }

  .article-content th {
    @apply bg-skin-muted/10 font-bold text-skin-base;
  }
</style>
